# ASP.NET MVC validation with jQuery AJAX

This directory, [`dotnet-web-mvc-validation`](../dotnet-web-mvc-validation), represents the recommended way [ASP.NET Core](https://en.wikipedia.org/wiki/ASP.NET_Core) MVC should support validation with jQuery Validation by J√∂rn Zaefferer [üìñ [docs](https://jqueryvalidation.org/documentation/)]. After a decade of avoiding this comprehensive study by working with SPAs, this sample represents my public recognition that jQuery [[GitHub](https://github.com/jquery)] (by the [OpenJS Foundation](https://openjsf.org/)) _still_ plays a default role in the surfacing of .NET validation solutions to the the Web.

This is also a realization of the obvious: validation is the heart and soul of ‚Äúfull stack‚Äù enterprise development. There will _never_ be a widely-accepted single approach to validation. Most of the complexity in the full stack is related to validation. In this sample, I want to continue operating within the turn-of-the-century limitations of Microsoft‚Äôs MVC defaults, pulling away slightly from my bottom-rung, [unobtrusive validation sample](https://github.com/BryanWilhite/dotnet-core/tree/master/dotnet-web-mvc-unobtrusive-validation) which does not use any custom JavaScript/jQuery.

This sample approaches the following goals:

- an editing experience with no post-backs, jQuery `$.ajax` only
- a design that does not need JavaScript/JSON interfaces to redundantly mirror server domain data
- an editing UX featuring a single `form`, presenting a ‚Äúmaster‚Äù `TodoList` over a collection of `TodoItem` detail, supporting adding/removing TODO items

Avoiding client-side types (custom JSON) makes this design simpler (but not useless). This encourages me to trust what Microsoft (and OpenJS Foundation) is offering out of the box. Simultaneously, the editing UX demands that collections of data be supported, increasing the complexity. Most of the custom JavaScript promised in this sample work toward this editing UX.

## sample set up

From the `dotnet-web-mvc-validation/` [directory](../dotnet-web-mvc-validation):

```bash
dotnet new sln -n Songhay.Validation
dotnet new mvc -o Songhay.Validation.Web
dotnet sln Songhay.Validation.sln \
      add Songhay.Validation.Web/Songhay.Validation.Web.csproj

dotnet add \
    Songhay.Validation.Web/Songhay.Validation.Web.csproj \
    package FluentValidation

dotnet add \
    Songhay.Validation.Web/Songhay.Validation.Web.csproj \
    package FluentValidation.AspNetCore

touch Songhay.Validation.Web/Controllers/TodosController.cs

touch Songhay.Validation.Web/Models/ITodosContext.cs
touch Songhay.Validation.Web/Models/TodoItem.cs
touch Songhay.Validation.Web/Models/TodoItemValidator.cs
touch Songhay.Validation.Web/Models/TodoList.cs
touch Songhay.Validation.Web/Models/TodoListValidator.cs
touch Songhay.Validation.Web/Models/TodosContext.cs

mkdir Songhay.Validation.Web/Views/Todos
touch Songhay.Validation.Web/Views/Todos/Index.cshtml
touch Songhay.Validation.Web/Views/Todos/Edit.cshtml
touch Songhay.Validation.Web/Views/Todos/_TodoItem.cshtml
```

## sample highlights

### the jQuery of `site.js`

To avoid polluting global scope in the turn-of-the-century jQuery time frame, we use an _Immediately Invoked Function Expression_ (IIFE, [üìñ [docs](https://developer.mozilla.org/en-US/docs/Glossary/IIFE)]) of the form:

```javascript
(($) => {
    $(() => {
        //members
    });
})(jQuery);
```

Along with the IIFE, the default `site.js` [file](./Songhay.Validation.Web/wwwroot/js/site.js) has the following members:

| member | remarks |
|- |-
| `formatNewFieldGroup` | a function that formats a new `fieldset`, appended by the `#cmd-add` click event; it ensures that Microsoft collection-item naming conventions are enforced (`Items_n__` for an `id` prefix and `Items[n].` for a `name` prefix ) |
| `renumberFormGroup` | replaces the collection ordinal, _n_ for an `id` and for a `name` attribute |
| `renumberFieldsets` | calls `renumberFormGroup` for every collection-item `fieldset` |
| `removeCommand` | defines the procedure invoked by `.cmd.remove` click events which are attached when document-ready fires and when a new `fieldset` is appended by the `#cmd-add` click event |
| `removeFieldSetHiddenField` | removes the hidden fields generated by Microsoft whenever `input[type="checkbox"]` is rendered |
| `$.validator.setDefaults` | this appears in an attempt respect [the validation UX of Bootstrap](https://getbootstrap.com/docs/5.2/forms/validation/#content) |
| `.cmd.remove` click event handler | allows TODO items to be removed |
| `#cmd-add` click event handler | allows TODO items to be added |
| `#cmd-save` click event handler | allows TODO items to be saved |

More than half of the members summarized above have _nothing_ to do with business rules or anything that would be explicitly specified by a user story. When I was a younger, less experienced developer, I would have been excited about all of this extra work!

#### Microsoft collection-item naming conventions

When you want to pass a collection via `serializeArray` from jQuery [üìñ [docs](https://api.jquery.com/serializeArray/#serializeArray)], then you _must_ use `@Html.EditorFor` instead of awaiting `Html.PartialAsync` because of the conventions around how Microsoft adds collection-ordinal prefixes to the `id` and `name` attributes of form elements, generated by a `@for` loop:

```csharp
@for (var i = 0; i < Model.Items.Count; i++)
{
    @Html.EditorFor(model => model.Items[i])
}
```

‚Äú[Collection Editing with MVC](https://www.abstractmethod.co.uk/blog/2017/12/collection-editing-with-mvc/)‚Äù details these conventions.

#### the validation UX of Bootstrap

In my experience, the punishment for respecting [the validation UX of Bootstrap](https://getbootstrap.com/docs/5.2/forms/validation/#content) was immediate and severe. Applying `invalid-feedback` or `valid-feedback` to an `input` element caused them to disappear‚Äîand this is exactly what jQuery Validation will do when `errorClass: 'invalid-feedback'` or `validClass: 'valid-feedback'`.

This brutal experience tricks me into thinking that jQuery Validation and Bootstrap are not working together by default.

#### the `.cmd.remove` click event handler

The `.one` [üìñ [docs](https://api.jquery.com/one/#one-events-data-handler)] jQuery function is used for the `.cmd.remove` click event. This is done because this event should fire only once per `fieldset`.

#### the `#cmd-add` click event handler

This handler challenged me with finding the maximum ID number among the TODO items so the next ID could be calculated (on the server) without resorting to [Underscore.JS](https://underscorejs.org/) or [Lodash](https://lodash.com/). Modern JavaScript comes to the rescue with `Math.max` and the spread operator [üìñ [docs](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/max)]:

```javascript
const ids = [];
fieldsets.each((i, fieldset) => {
    const id = parseInt($('input[name$=".Id"]', fieldset).val(), 10);
    ids.push(id);
});
const maxId = Math.max(...ids);
```

Work on this handler also showed me the way of explicitly passing `__RequestVerificationToken`, according to [a StackOverflow answer](https://stackoverflow.com/a/2906780/22944) from 2010:

```javascript
const token = $(`input[type="hidden"][name=${tokenName}]`, todosForm).val();

//‚Ä¶

$.ajax({
    url: '../../Todos/AddRow/',
    type: 'POST',
    data: { __RequestVerificationToken: token, maxId },
    error: (jqXHR, textStatus, errorThrown) => {
        console.error({jqXHR, textStatus, errorThrown});
    },
    success: (data, textStatus, jqXHR) => {
        console.info({data, textStatus, jqXHR});
    }
});
```

Without this explicit passing, a `POST` to an endpoint adorned with `ValidateAntiForgeryToken` [üìñ [docs](https://docs.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-6.0)] will throw a Bad Request error.

Both `__RequestVerificationToken` and `maxId` are passed as a plain-old JavaScript object (which kind of looks like JSON), `POST`ed as `application/x-www-form-urlencoded`. ASP.NET Core auto-magically maps `maxId` to the argument of the same name on `TodosController.AddRow`. This convention is super convenient and should eliminate the need to have controllers that read raw JSON from a steam or have an argument of type `Newtonsoft.Json.Linq.JObject` [üìñ [docs](https://www.newtonsoft.com/json/help/html/T_Newtonsoft_Json_Linq_JObject.htm)].

#### the `#cmd-save` click event handler

This handler features the most flexible use of jQuery Validation:

```javascript
    if (todosForm.validate)
    {
        const validator = todosForm.validate();

        // Call:
        //    `$(input).rules('add', {});`
        // or:
        //    `$.validator.addClassRules('class-name', {});`
        // when the UX needs it.

        if(!validator.form()) { return; }
    }
```

The use of `validator.form` eliminates the need to use a `button` or `input` of type `submit` which could make browser back-button UX problematic. A `validator.form` call also displays multiple validation errors at once.

When showing multiple validation errors is not preferred, the following pattern is an alternative:

```javascript
if (todosForm.validate)
{
    todosForm.validate();

    const controls = $('select,input', todosForm);

    for(let control of controls) {
        const isValid = $(control).valid();

        if(!isValid) {
            control.focus();
            return;
        }
    }
}
```

This ‚Äòcontrols‚Äô-level validation is useful when a form has input elements that should _not_ be validated (but the formal way to do this is with the `ignore` selector [üìñ [docs](https://jqueryvalidation.org/validate/#ignore)]).

Instead of passing all data as JSON, we keep things simpler with `serializeArray` from jQuery [üìñ [docs](https://api.jquery.com/serializeArray/#serializeArray)].

#### none of the `$.ajax` calls specify a MIME type

When the `#cmd-add` request is sent to the server it is `Content-Type: application/x-www-form-urlencoded; charset=UTF-8` but the response is `text/html; charset=utf-8` which goes all the way back to my ancient times with ASP on IIS, returning XHTML from [SQL Server XML](https://docs.microsoft.com/en-us/sql/relational-databases/xml/xml-data-sql-server?view=sql-server-ver16) on a 1990s bandwagon Microsoft called _dynamic HTML_ and Google would later call, _AJAX_.

When the `#cmd-save` request is sent, it is also `application/x-www-form-urlencoded` (because of the use of `serializeArray` from jQuery [üìñ [docs](https://api.jquery.com/serializeArray/#serializeArray)]) but no content is returned, only a 200 (OK) status which reminds me of my turn-of-the-century salad days with ASP.NET Web API. But in those salad days, I would have specified _everything_ in `application/json` which forces me to define a bunch of client-side types.

By not specifying an `$.ajax` MIME type, the content-negotiation features of ASP.NET take over and can make life easier for less experienced developers (or developers who are not yet into micro-services or RESTful APIs) while not sacrificing flexibility.

#### ‚Äòadvanced‚Äô use of `String.prototype.replace()`

I am a bit embarrassed to admit that not only do I _not_ use the regular expression flavor of `replace` very often but I also had no idea there was a ‚Äúreplacer‚Äù function feature [üìñ [docs](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace)]:

```javascript
const regex = /[\[_](\d+)[_\]]/
const replacer = (match, p1) => {
    return match.replace(p1, i);
};
const input_id = input.attr('id').replace(regex, replacer);
```

### the `TodosController`

#### `IValidator<TodoList>` injected as transient

The `IValidator<T>` type comes from FluentValidation [[GitHub](https://github.com/FluentValidation/FluentValidation)]. My intent is to validate with an explicit statement in the `TodosController.Save` method instead of letting `FluentValidation.AspNetCore` add validation results to ModelState [üìñ [docs](https://docs.fluentvalidation.net/en/latest/aspnet.html#using-the-validator-in-a-controller)].

I am under the impression that `FluentValidation.AspNetCore` works best with [unobtrusive](https://github.com/BryanWilhite/dotnet-core/tree/master/dotnet-web-mvc-unobtrusive-validation) validation and should not be needed here. However, I am seeing unobtrusive style validation attributes _still_ showing up on the form when only `FluentValidation` is installed.

The first sentence in the `FluentValidation` ASP.NET Core [documentation](https://docs.fluentvalidation.net/en/latest/aspnet.html#asp-net-core) is quite clear:

>FluentValidation supports integration with ASP.NET Core 3.1 or ASP.NET Core running on .NET 5. Once enabled, MVC will use FluentValidation to validate objects that are passed in to controller actions by the model binding infrastructure.

What is less clear is how to turn this behavior off, specifically the attribute generation.

#### the `TodosController.AddRow` method

The `TodosController.AddRow` method is just one lone of code:

```csharp
[HttpPost]
[ValidateAntiForgeryToken]
public IActionResult AddRow(int maxId)
{
    return PartialView("EditorTemplates/TodoItem", new TodoItem { Id = ++maxId });
}
```

Instead of constructing the UI around `TodoItem` on the client-side, we send back a chunk of HTML with `PartialView`. Instead of defining custom JSON on the client side, mirroring types on the server side, ASP.NET knows how to fill `maxId` from an anonymous JavaScript object. Now I understand how a secure and effective ASP.NET Core roundtrip can be whipped up quite quickly (perhaps for a job interview in the early 2000s)!

## general recommendations

On the client side:

- understand that [HTML5 validation](https://developer.mozilla.org/en-US/docs/Learn/Forms/Form_validation) should be at the core of our design thinking
- consider calling `$(control).valid()` on individual form elements for maximum flexibility of form design
- leverage [Bootstrap validation](https://getbootstrap.com/docs/5.1/forms/validation/) UX in harmony with the MVC defaults

On the server side:

- use FluentValidation [[GitHub](https://github.com/FluentValidation/FluentValidation)] (and FluentValidation.AspNetCore [[GitHub](https://github.com/FluentValidation/FluentValidation)]) with static methods in classes implementing `AbstractValidator<T>` that emit form validation attributes
- test `AbstractValidator<T>` classes with help from Bogus [[GitHub](https://github.com/bchavez/Bogus)] and AutoBogus [[GitHub](https://github.com/nickdodd79/AutoBogus)]
- prevent unnecessary server-side validation (and redundantly saving data) with Compare-Net-Objects [[GitHub](https://github.com/GregFinzer/Compare-Net-Objects)]

## other validation-related notes

### the importance of calling `ModelState.Clear()`

When validation errors show up in the client _after_ a post-back, this means ASP.NET validations conventions are working correctly, reading the contents of `Controller.ModelState` [üìñ [docs](https://docs.microsoft.com/en-us/dotnet/api/system.web.mvc.controller.modelstate?view=aspnet-mvc-5.2)]. When these errors are unexpected, this is likely a side effect of server-side validation being out of sync with client-side validation. This likely happens when the model passed to the controller method is _not_ the model that is saved to the data store. `Controller.ModelState` is bound to the data passed to the controller which can be deemed irrelevant after it is processed in some kind of server-side transformation. When such a transformation is considered successful, then we should call `ModelState.Clear()` to prevent unexpected validation errors after post-back.

### `enum` and the `select` element

I must not forget about the `@Html.GetEnumSelectList` method [üìñ [docs](https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.viewfeatures.htmlhelper.getenumselectlist?view=aspnetcore-6.0)]. This HTML Helper turns an `enum` into a dropdown list as described in ‚Äú[ASP.NET Core - how to bind enum to HTML select tag](https://kmatyaszek.github.io/2019/10/27/asp.net-core-how-to-bind-enum-to-html-select-tag.html).‚Äù

A StackOverflow [answer](https://stackoverflow.com/a/53742229/22944) shows what we might end up with:

```html
<select asp-for="Status" 
        asp-items="Html.GetEnumSelectList<EnumStatus>()" 
        class="form-control>
    <option selected="selected" value="">Please select</option>
</select>
```

And, in case there are edge cases where we cannot use this Helper, we can resort to something like [this](https://stackoverflow.com/a/55506887/22944):

```csharp
<select class="custom-select" asp-for="ValueType.Controller">
@foreach (var e in Enum.GetValues(typeof(ValueTypeModel.PageType)).Cast<int>())
{
    if (Enum.GetName(typeof(ValueTypeModel.PageType), e) == Model.ValueType.Controller)
    {
        <option value="@e.ToString()" selected>@Enum.GetName(typeof(ValueTypeModel.PageType), e)</option>
    }
    else
    {
        <option value="@e.ToString()">@Enum.GetName(typeof(ValueTypeModel.PageType), e)</option>
    }
}
</select>
```

### there is no `System.Web.Mvc.Ajax` in the world of .NET Core

The `System.Web.Mvc.Ajax` namespace contained helpers like `AjaxExtensions.BeginForm` [üìñ [docs](https://docs.microsoft.com/en-us/dotnet/api/system.web.mvc.ajax.ajaxextensions.beginform?view=aspnet-mvc-5.2)] which might be carried around in the `MicrosoftMvcAjax.Mvc5` [NuGet package](https://www.nuget.org/packages/MicrosoftMvcAjax.Mvc5/). I assume this work is not continued and not intended for the world of .NET Core because of the dependency on jQuery libraries‚Äîand jQuery itself has been regarded as a legacy technology for over a decade. A relatively recent article on this subject is ‚Äú[ASP.NET MVC 5 - Razor AJAX Form Control](https://www.c-sharpcorner.com/article/asp-net-mvc5-razor-ajax-form-control/).‚Äù

## related links

- [according to Wikipedia](https://en.wikipedia.org/wiki/ASP.NET_MVC), the final release of ASP.NET MVC was 2022-04-12
- [jqueryvalidation.org](https://jqueryvalidation.org/)
- ‚Äú[The Most Indispensable jQuery Form Validation Reference Guide](https://www.javascript-coder.com/form-validation/jquery-form-validation-guide/)‚Äù
- jQuery Validation: with `.rules()` validation for datalist [[CodePen](https://codepen.io/rasx/pen/RwQdBzO)]
- Form Helper [[GitHub](https://github.com/sinanbozkus/FormHelper)] [[Form Helper sample project](https://github.com/sinanbozkus/fluent-validation-with-form-helper/tree/master/StudentProject)]

@[BryanWilhite](https://twitter.com/BryanWilhite)
